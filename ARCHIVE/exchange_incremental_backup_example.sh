#!/bin/bash
# Exchange Incremental Backup Usage Example
# This script demonstrates how to use the Exchange incremental backup tool

echo "=========================================="
echo "Exchange Incremental Backup Usage Example"
echo "=========================================="
echo ""

# Check if environment variables are set
if [ -z "$EXCHANGE_TENANT_ID" ] || [ -z "$EXCHANGE_CLIENT_ID" ] || [ -z "$EXCHANGE_CLIENT_SECRET" ]; then
    echo "❌ ERROR: Exchange environment variables not set!"
    echo ""
    echo "Please set the following environment variables:"
    echo "  export EXCHANGE_TENANT_ID='your-tenant-id'"
    echo "  export EXCHANGE_CLIENT_ID='your-client-id'"
    echo "  export EXCHANGE_CLIENT_SECRET='your-client-secret'"
    echo ""
    echo "Or create a .env.exchange file:"
    echo "  cp .env.exchange.example .env.exchange"
    echo "  # Edit .env.exchange with your credentials"
    echo ""
    exit 1
fi

echo "✅ Exchange credentials configured"
echo ""

# Create backup directory if it doesn't exist
BACKUP_DIR="backup/exchange"
mkdir -p "$BACKUP_DIR"
echo "✅ Backup directory: $BACKUP_DIR"
echo ""

echo "=========================================="
echo "Example 1: First Full Backup"
echo "=========================================="
echo ""
echo "To perform your first full backup (populates checksum database):"
echo ""
echo "  uv run --env-file .env.exchange exchange_incremental_backup.py --type full"
echo ""
echo "This will:"
echo "  • Discover all mailboxes in your tenant"
echo "  • Backup all emails (up to --max-emails per user)"
echo "  • Create checksum database for future incremental backups"
echo "  • Preserve folder structure"
echo "  • Include attachments"
echo "  • Create both EML and JSON files"
echo ""

echo "=========================================="
echo "Example 2: Incremental Backup (Default)"
echo "=========================================="
echo ""
echo "To perform incremental backup (only changed emails):"
echo ""
echo "  uv run --env-file .env.exchange exchange_incremental_backup.py"
echo ""
echo "This will:"
echo "  • Only backup new or changed emails"
echo "  • Skip unchanged emails (saves 90-98% time)"
echo "  • Update checksum database"
echo "  • Much faster than full backup"
echo ""

echo "=========================================="
echo "Example 3: Custom Incremental Backup"
echo "=========================================="
echo ""
echo "Custom incremental backup with specific options:"
echo ""
echo "  uv run --env-file .env.exchange exchange_incremental_backup.py \\"
echo "    --type incremental \\"
echo "    --backup-dir backup/exchange_custom \\"
echo "    --max-emails 500 \\"
echo "    --no-attachments \\"
echo "    --format json"
echo ""
echo "This will:"
echo "  • Backup to custom directory"
echo "  • Limit to 500 emails per user"
echo "  • Skip attachments (faster)"
echo "  • Create only JSON files (no EML)"
echo ""

echo "=========================================="
echo "Example 4: View Backup Statistics"
echo "=========================================="
echo ""
echo "To view backup statistics:"
echo ""
echo "  uv run --env-file .env.exchange exchange_incremental_backup.py --stats"
echo ""
echo "This will show:"
echo "  • Total backups in last 30 days"
echo "  • Emails backed up vs skipped"
echo "  • Attachment statistics"
echo "  • Backup type distribution"
echo "  • User distribution"
echo "  • Recent backup history"
echo ""

echo "=========================================="
echo "Example 5: Cleanup Old Records"
echo "=========================================="
echo ""
echo "To cleanup old backup records (keep last 90 days):"
echo ""
echo "  uv run --env-file .env.exchange exchange_incremental_backup.py --cleanup 90"
echo ""
echo "This will:"
echo "  • Remove backup history older than 90 days"
echo "  • Keep current email records"
echo "  • Free up database space"
echo ""

echo "=========================================="
echo "Example 6: Test Run (Dry Run)"
echo "=========================================="
echo ""
echo "To test without actually downloading emails:"
echo ""
echo "  # Create test configuration"
echo "  cp .env.exchange.example .env.exchange.test"
echo "  # Edit .env.exchange.test with test credentials"
echo ""
echo "  # Run with limited emails"
echo "  uv run --env-file .env.exchange.test exchange_incremental_backup.py \\"
echo "    --type incremental \\"
echo "    --max-emails 10 \\"
echo "    --backup-dir backup/exchange_test"
echo ""
echo "This will:"
echo "  • Test authentication"
echo "  • Discover mailboxes"
echo "  • Process only 10 emails per user"
echo "  • Verify incremental logic works"
echo ""

echo "=========================================="
echo "Scheduling with Cron"
echo "=========================================="
echo ""
echo "Schedule daily incremental backups:"
echo ""
echo "  # Edit crontab: crontab -e"
echo "  # Add this line for daily at 2 AM:"
echo "  0 2 * * * cd /home/jph/SRC/microsoft-365-backup-tools && \\"
echo "    uv run --env-file .env.exchange exchange_incremental_backup.py \\"
echo "    >> /var/log/exchange_backup.log 2>&1"
echo ""
echo "Schedule weekly full backups:"
echo ""
echo "  # Add this line for Sunday at 3 AM:"
echo "  0 3 * * 0 cd /home/jph/SRC/microsoft-365-backup-tools && \\"
echo "    uv run --env-file .env.exchange exchange_incremental_backup.py \\"
echo "    --type full >> /var/log/exchange_backup_full.log 2>&1"
echo ""

echo "=========================================="
echo "Troubleshooting"
echo "=========================================="
echo ""
echo "1. Check logs:"
echo "   tail -f exchange_incremental_backup.log"
echo ""
echo "2. Test authentication:"
echo "   uv run --env-file .env.exchange python test_exchange_auth.py"
echo ""
echo "3. Test incremental logic:"
echo "   python test_exchange_incremental.py"
echo ""
echo "4. Check database:"
echo "   sqlite3 backup_checksums_exchange.db"
echo "   .tables"
echo "   SELECT COUNT(*) FROM email_messages;"
echo "   .exit"
echo ""
echo "5. View backup directory:"
echo "   ls -la backup/exchange/"
echo "   find backup/exchange/ -name \"*.json\" | head -5"
echo ""

echo "=========================================="
echo "Quick Start Summary"
echo "=========================================="
echo ""
echo "1. Configure credentials:"
echo "   cp .env.exchange.example .env.exchange"
echo "   # Edit .env.exchange with your Azure AD credentials"
echo ""
echo "2. Run first full backup:"
echo "   uv run --env-file .env.exchange exchange_incremental_backup.py --type full"
echo ""
echo "3. Schedule incremental backups:"
echo "   # Add to crontab as shown above"
echo ""
echo "4. Monitor with statistics:"
echo "   uv run --env-file .env.exchange exchange_incremental_backup.py --stats"
echo ""
echo "✅ Exchange incremental backup is ready to use!"
echo ""